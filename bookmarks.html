<!DOCTYPE html>

<html>
<head>
  <meta charset=utf-8 />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bookmarks</title>

<!-- Stylesheets -->
<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" type="text/css" rel="stylesheet">
<style>
body {background: black; color: white;}
</style>

<!-- Common Javascript -->
<script src="https://www.gstatic.com/firebasejs/5.7.2/firebase.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="bootstrap-treeview.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>
<script src="common.js?z"></script>

</head>
<body>


<!-- 
============================ EDITOR ====================================
-->
Bookmarks: 
<a href="javascript:toggleTextArea()">edit</a> - 
<div id="editorDiv" style="display:none;">
  <textarea id="editor" style="width:100%; height:600px; color:black;"></textarea>
</div>
<a id="savelink" href="#" onclick="saveData();localStorage.setItem('backupdata', getLocal());$('#savelink').removeAttr('style');">save</a>

<script>
function toggleTextArea() {
  if ($('#editorDiv').css("display")=='block'){
    $('#savelink').css({'color': 'yellow'});
    $('#editorDiv').css({'display': 'none'});
    var data = JSON.stringify(JSON.parse($('#editor').val())); //flatten
    updateTree(data);
  }
  else{
    $('#editorDiv').css({'display': 'block'});
    var prettify = getLocal().replace(/},/g,"},\n").replace(/],/g,"\n],").replace(/\[/g,"[\n"); //prettify
    $('#editor').val(prettify); //edit
  }
}

</script>

  
<!-- 
============================ TREE DISPLAY ====================================
-->
<div id="tree"></div>
&nbsp;&nbsp;<a href="#" onclick="addItem(prompt('URL to add:')); saveData(refreshTree);">add+</a> - 
<a href="http://jsoneditoronline.org/?json=[]" target="_blank">manage</a> - 
<a href="#" onclick="localStorage.clear(); location.reload()">sign-out</a>
<script>//https://github.com/jonmiles/bootstrap-treeview
var expanded = new Set();
function updateTree(json) {
  if (!json) {
    return;
  }
  saveLocal(json);
  tdebug('refreshing menu'); 
  $('#tree').treeview({
    data: JSON.parse(json),
    enableLinks: true,
    backColor: '#000000',
    onhoverColor: '#333366',
    borderColor: '#333333',
    expandIcon: 'glyphicon glyphicon-chevron-right',
    collapseIcon: 'glyphicon glyphicon-chevron-down',
    showCheckbox: true,
    checkedIcon: "glyphicon glyphicon-option-horizontal",
    uncheckedIcon: "glyphicon glyphicon-option-horizontal"
  });
  $('#tree').on('nodeChecked', function(event, data) { //delete, move
    var moveto = prompt(data.text + "\n\nDELETE?\n\n('Ok' to delete. Type folder name, to move)");
    if (moveto!=null) {cutItem(data.text, moveto); saveData(refreshTree);};
    $('#tree').treeview('uncheckAll', { silent: true });
  });
  $('#tree').on('nodeSelected', function(event, data) {//select->toggle
    if (!data.href){
      $('#tree').treeview('toggleNodeExpanded', data.nodeId);
    }
  });
  //remember expanded
  $('#tree').on('nodeExpanded', function(event, data) {
    expanded.add(data.nodeId);
  });
  $('#tree').on('nodeCollapsed', function(event, data) {
    expanded.delete(data.nodeId);
  });
  $('#tree').treeview('collapseAll', { silent: true });  
  var expandedArr = Array.from(expanded);
  for (var nid in expandedArr){ 
    $('#tree').treeview('expandNode', expandedArr[nid]);
  }
}

//IF ADD e.g. bookmarks.html#<new url>
function resetPage(){
  setTimeout("window.location.href = 'bookmarks.html'", 1000); //fix for hash reset
}
if (window.location.hash){
  var url = window.location.hash.substr(1);
  addItem(url);
  saveData(resetPage);
}

//LOAD MENU
function refreshTree(){
  updateTree(getLocal());
}
$( document ).ready(function() {
  refreshTree(); //local
  getData(refreshTree); //remote
});

</script>

<!-- 
============================ DEBUG OUTPUT ====================================
-->
<br><br><textarea id="tdebug" style="display:none; width:100%; height:150px; background-color:#333333; color:#ffff00; font-size:10px;">============
debug output</textarea>
<a href="#" onclick="$('#tdebug').css({'display': 'block'});">#</a>

</body>
</html>
