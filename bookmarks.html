<!DOCTYPE html>

<html>
<head>
  <meta charset=utf-8 />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bookmarks</title>

<meta name="referrer" content="no-referrer">

<!-- Stylesheets -->
<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" type="text/css" rel="stylesheet">
<style>
body {background: black; color: white;}
</style>

<!-- Scripts -->
<script src="https://www.gstatic.com/firebasejs/5.7.2/firebase.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="bootstrap-treeview.js?z"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>
<script src="common.js"></script>
<script type="text/javascript" src="jsonQ.min.js"></script>

</head>
<body>

<!-- 
............. EDITOR .............
-->
<span id="localname"></span>: 
<a href="javascript:toggleTextArea()">edit</a> - 
<div id="editorDiv" style="display:none;">
  <textarea id="editor" style="width:100%; height:600px; color:black;"></textarea>
</div>
<a id="savelink" href="#" onclick="G.postData(); G.backupLocal(); $('#savelink').removeAttr('style');">save</a>

<script>
function toggleTextArea() {
  if ($('#editorDiv').css("display")=='block'){
    debug('----- close editor -----');
    $('#savelink').css({'color': 'yellow'});
    $('#editorDiv').css({'display': 'none'});
    G.save( JSON.parse($('#editor').val()) );
    updateTree();
  }
  else{
    debug('----- open editor -----');
    $('#editorDiv').css({'display': 'block'});
    var prettify = G.tjson.replace(/},/g,"},\n").replace(/],/g,"\n],").replace(/\[/g,"[\n"); //prettify
    $('#editor').val(prettify); //edit
  }
}

</script>

<!-- 
............. TREE DISPLAY .............
-->
<div id="tree"></div>
&nbsp;&nbsp;<a href="#" onclick="addItem(prompt('URL to add:')); G.postData(updateTree);">add+</a> - 
<a href="http://jsoneditoronline.org/?json=[]" target="_blank">manage</a> - 
<a href="#" onclick="localStorage.clear(); location.reload()">sign-out</a>

<script>// https://github.com/jonmiles/bootstrap-treeview


// GLOBALS
var rootids; //#tree root ids
var G; //load on ready


//================= UPDATE TREE
function updateTree() {
    debug('----- updateTree -----');

  if (!G.tjson) {
    return;
  }

  rootids = []; //root folders
  jQuery(G.tdata).each(function (i){ 
    rootids.push(G.tdata[i].text); 
  });

  $('#tree').treeview({
    data: G.tdata,
    enableLinks: true,
    backColor: '#000000',
    onhoverColor: '#333366',
    borderColor: '#333333',
    expandIcon: 'glyphicon glyphicon-chevron-right',
    collapseIcon: 'glyphicon glyphicon-chevron-down',
    showCheckbox: true,
    checkedIcon: "glyphicon glyphicon-option-horizontal",
    uncheckedIcon: "glyphicon glyphicon-option-horizontal"
  });

  //ON NODE MENU -------------------
  $('#tree').on('nodeChecked', function(event, data) { //delete, move
    var moveto = prompt(data.text + "\n\nTo DELETE, Press 'ok'.\n\nTo MOVE, type folder name:");
    if (moveto!=null) {cutItem(data.text, moveto); G.postData(updateTree);};
    $('#tree').treeview('uncheckAll', { silent: true });
  });

  //ON NODE SELECT -------------------
  $('#tree').on('nodeSelected', function(event, data) {//select->toggle
    if (!data.href){
      $('#tree').treeview('toggleNodeExpanded', data.nodeId);
    }
    $('#tree').treeview('toggleNodeSelected', data.nodeId); //de-select
  });

  //ON NODE EXPAND -------------------
  $('#tree').on('nodeExpanded', function(event, data) {
    if (rootids.includes(data.text)) { //if is root
      var opened = $('#tree').treeview('getExpanded');
      jQuery(opened).each(function (i){ //close others
        if (opened[i].text != data.text){
          $('#tree').treeview('collapseNode', opened[i]);
        }
      });
    }
    G.expanded.add(data.nodeId);
    G.saveExpanded();
  });

  //ON NODE COLLAPSE -------------------
  $('#tree').on('nodeCollapsed', function(event, data) {
    G.expanded.delete(data.nodeId);
    G.saveExpanded();
  });

  //RE-EXPAND -------------------
  $('#tree').treeview('collapseAll', { silent: true });  
  var expandedArr = Array.from(G.expanded);
  for (var nid in expandedArr){ 
    try{
      $('#tree').treeview('expandNode', expandedArr[nid]);
    }
    catch{ //forget not found
      G.expanded.delete(expandedArr[nid]);
      G.saveExpanded();
    }
  }

}

//================= LOAD PAGE, MENU 
$(document).ready(function() {
  debug('----- ready -----');

  //G config init
  var qs = new URLSearchParams(window.location.search);
  //optional url config: _.html?storageid=<storageid>&remember=<true/false>
  G = new Config(qs.get('storageid'), qs.get('remember'));
  $("#localname").html(G.STORAGEID);

  //show menu tree
  updateTree();
  G.fetchData(updateTree); //remote

  //add from bookmarklet:  _.html#<new url>
  if (window.location.hash){
    var url = window.location.hash.substr(1);
    addItem(url);
    G.postData(function(){window.location.href = window.location.href.split("#")[0]});
  }

});

</script>


</body>
</html>
